name: Linux_GUI_RDP_V5

on:
  workflow_dispatch:

jobs:
  linux-gui:
    # අපි පරණ, ස්ටේබල් වර්ෂන් එකක් ගන්නවා
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: Update and Install Desktop Environment
        run: |
          sudo apt-get update
          # Install XFCE and XRDP (Standard packages)
          sudo apt-get install -y xfce4 xfce4-goodies xrdp
          sudo systemctl enable xrdp
          sudo service xrdp start

      - name: Configure User and Session (Simple & Stable)
        run: |
          # Create user
          sudo useradd -m -s /bin/bash runneradmin
          echo "runneradmin:password123" | sudo chpasswd
          sudo usermod -aG sudo,ssl-cert runneradmin
          
          # Simple session config for Ubuntu 22.04
          sudo -u runneradmin bash -c 'echo "xfce4-session" > /home/runneradmin/.xsession'
          sudo chmod 755 /home/runneradmin/.xsession
          
          # Fix Polkit issues (Optional but good for stability)
          sudo bash -c 'cat > /etc/polkit-1/localauthority/50-local.d/45-allow-colord.pkla <<EOF
          [Allow Colord all Users]
          Identity=unix-user:*
          Action=org.freedesktop.color-manager.create-device;org.freedesktop.color-manager.create-profile;org.freedesktop.color-manager.delete-device;org.freedesktop.color-manager.delete-profile;org.freedesktop.color-manager.modify-device;org.freedesktop.color-manager.modify-profile
          ResultAny=no
          ResultInactive=no
          ResultActive=yes
          EOF'

          # Restart XRDP
          sudo service xrdp restart
          
          echo "=========================================="
          echo "Username: runneradmin"
          echo "Password: password123"
          echo "=========================================="

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Start Tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          sudo tailscale up --authkey=$TAILSCALE_AUTH_KEY --hostname=linux-stable-box
          
      - name: Display IP Address
        run: |
          echo "=========================================="
          echo "Tailscale IP:"
          tailscale ip -4
          echo "=========================================="

      - name: Keep Alive Loop
        run: |
          while true; do
            sleep 300
          done
