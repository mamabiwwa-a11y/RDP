name: Linux_GUI_RDP_V6

on:
  workflow_dispatch:

jobs:
  linux-gui:
    # තාමත් අපි පරණ Ubuntu 22.04 එකේ ඉමු, ඒක ආරක්ෂිතයි.
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: Update and Install Desktop Environment
        run: |
          sudo apt-get update
          # Install basic tools + XFCE + XRDP + DBus
          sudo apt-get install -y xfce4 xfce4-goodies xrdp xorg dbus-x11 x11-xserver-utils
          sudo systemctl enable xrdp
          sudo service xrdp start

      - name: Create User and Inject Manual Startup Script
        run: |
          # 1. Create User
          sudo useradd -m -s /bin/bash runneradmin
          echo "runneradmin:password123" | sudo chpasswd
          sudo usermod -aG sudo,ssl-cert runneradmin
          
          # 2. Create the Manual Launch Script (Based on your research)
          # We write this into a dedicated script file
          sudo bash -c "cat > /home/runneradmin/start_gui.sh <<EOF
          #!/bin/bash
          
          # Manually create Runtime Directory if missing
          export XDG_RUNTIME_DIR=/run/user/\$(id -u)
          if [ ! -d \"\$XDG_RUNTIME_DIR\" ]; then
            mkdir -p \"\$XDG_RUNTIME_DIR\"
            chmod 700 \"\$XDG_RUNTIME_DIR\"
          fi
          
          # Spawn D-Bus Session manually
          if [ -z \"\$DBUS_SESSION_BUS_ADDRESS\" ]; then
             eval \$(dbus-launch --sh-syntax --exit-with-session)
          fi
          
          # Export Environment Variables
          export XDG_SESSION_TYPE=x11
          export XDG_CURRENT_DESKTOP=XFCE
          # We don't hardcode DISPLAY here, XRDP sets it automatically
          
          # Start XFCE inside a DBus session wrapper
          exec dbus-run-session -- xfce4-session
          EOF"

          # 3. Set Permissions and Link to .xsession
          sudo chmod +x /home/runneradmin/start_gui.sh
          sudo chown runneradmin:runneradmin /home/runneradmin/start_gui.sh
          
          # Point .xsession to execute our manual script
          sudo -u runneradmin bash -c 'echo "./start_gui.sh" > /home/runneradmin/.xsession'
          sudo chmod 755 /home/runneradmin/.xsession

          # Restart XRDP Service
          sudo service xrdp restart
          
          echo "=========================================="
          echo "Username: runneradmin"
          echo "Password: password123"
          echo "=========================================="

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Start Tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          sudo tailscale up --authkey=$TAILSCALE_AUTH_KEY --hostname=linux-manual-fix
          
      - name: Display IP Address
        run: |
          echo "=========================================="
          echo "Tailscale IP:"
          tailscale ip -4
          echo "=========================================="

      - name: Keep Alive Loop
        run: |
          while true; do
            sleep 300
          done
